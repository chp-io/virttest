---
- name: Get the System Kernel
  shell:
    uname -r
  register: result
- name: Print System Kernel
  debug:
    var: result
- name: Get HWE support status
  shell:
    hwe-support-status
  register: result
- name: Print HWE Support Status
  debug:
    var: result
- name: Install KVM
  ansible.builtin.apt:
    name:
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - bridge-utils
      - cpu-checker
      - ovmf
    state: present
  become: true
#- name: Add user to group libvirt and kvm
#  user:
#    name: vagrant
#    groups: libvirt,kvm
#    append: yes
- name: Check KVM
  shell:
    kvm-ok
  register: result
- name: Print kvm-ok status
  debug:
    var: result
- name: Run QEMU
  shell: |
    pwd
    wget https://github.com/chp-io/efi-shell/releases/download/edk2-stable202202/Shell.efi
    mkdir -p storage/EFI/BOOT
    echo "echo Hello world!" > storage/startup.nsh
    echo "reset -s" >> storage/startup.nsh
    mv Shell.efi storage/EFI/BOOT/BOOTX64.EFI
    grep "^Mem" /proc/meminfo
    sudo qemu-system-x86_64 -enable-kvm -machine q35 -cpu host -m 2G -bios /usr/share/OVMF/OVMF_CODE.fd -name guest=ivguest -nographic -drive format=raw,file=fat:rw:storage || true
- name: Install introvirt
  ansible.builtin.apt:
    name: 
      - libintrovirt1 
      - libintrovirt-doc
      - libintrovirt-dev
      - introvirt-tools
    state: present
  become: true
- name: Run ivversion
  shell:
    ivversion
  register: result
  become: true
- name: Print System Kernel
  debug:
    var: result
